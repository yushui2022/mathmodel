from langchain_core.prompts import ChatPromptTemplate

# 2.1 全局Agent前置提示（核心身份定义）
GLOBAL_AGENT_PROMPT = """你作为数学建模比赛专家，在接收用户提供的赛题后，需自主决策并生成论文模板，请紧密围绕知识库评估适配性最优的模型，全力生成文档，过程中禁止反问，无需询问论文标题，直接自主拟定，标题要贴合所选模型！
严格遵循指定的字数、段落规范，严谨完成内容撰写，确保生成的内容结构清晰、可读性强，暂无法确定的内容留空并添加【需补充】标记提示读者。生成内容必须为中文。"""

# 2.2 摘要生成提示词
ABSTRACT_PROMPT_TEMPLATE = ChatPromptTemplate.from_messages([
    ("system", GLOBAL_AGENT_PROMPT),
    ("system", """数学建模论文摘要必须严格按照以下格式生成，字数总计800字左右，全中文输出：
### 摘要模板
**第一段100字：**
本文通过建立和分析数学模型，解决了[具体问题]，对[相关领域或实际应用]具有重要的理论和实践意义。

**第二段50字：**
在模型建立方面，针对问题一，我们构建了一个基于[模型或评价体系名称]的模型；针对问题二，我们发展了一个基于[模型或评价体系名称]的模型；对于问题三，我们提出了一个基于[模型或评价体系名称]的模型。

**第三段150字：**
针对问题一，我们建立了[具体模型名称]，运用[使用的软件名称]，采用了[使用的算法或方法]，计算了[需要计算的变量或参数]，进行了[预测/评价/分析等]，以[具体目的或效果]。

**第四段150字：**
针对问题二，我们构建了[具体模型名称]，利用[使用的软件名称]，实施了[使用的算法或方法]，分析了[需要分析的数据或现象]，完成了[预测/评价/分析等]，旨在[具体目的或效果]。

**第五段150字：**
针对问题三，我们发展了[具体模型名称]，通过[使用的软件名称]，应用了[使用的算法或方法]，评估了[需要评估的指标或影响]，实现了[预测/评价/分析等]，以期达到[具体目的或效果]。

**第六段100字：**
通过这些模型的建立和验证，我们得到了[具体结果或发现]。在分析模型的优缺点后，我们提出了[改进措施或建议]，以期提高模型的[准确性/实用性/效率]。
请严格按照上述分段和字数要求生成摘要，自主拟定论文标题，标题要贴合所选模型！"""),
    ("human", """请根据以下数学建模赛题相关信息生成摘要：
赛题相关信息：{user_prompt}
知识库参考内容：{context}
要求：摘要总字数800字左右，严格按指定分段格式生成，标题自主拟定且贴合模型！""")
])

# 2.3 问题重述
PROBLEM_RESTATEMENT_PROMPT = ChatPromptTemplate.from_messages([
    ("system", GLOBAL_AGENT_PROMPT),
    ("system", """数学建模论文问题重述必须严格按照以下格式生成，必须全中文：
**第一段300字: 1.1 问题背景:** 写出该问题出现的问题背景,可以从社会,时代,问题现实,问题原因等角度写,字数200-400字。
**第二段: 1.2 问题提出:** 重述赛题问题,可润色但严禁改变题意。
请基于已生成的摘要内容，严格按此格式生成问题重述！"""),
    ("human", """请根据以下摘要内容生成问题重述：
摘要内容：{abstract_content}
赛题相关信息：{user_prompt}
知识库参考内容：{context}
要求：严格按指定分段和字数要求生成！""")
])

# 2.4 问题分析
PROBLEM_ANALYSIS_PROMPT = ChatPromptTemplate.from_messages([
    ("system", GLOBAL_AGENT_PROMPT),
    ("system", """数学建模论文问题分析必须严格按照以下格式生成，必须全中文，要求：中肯、确切；术语专业、内行；原理依据正确、明确；表述简明，关键步骤列出；忌外行话、术语不明确、表述混乱冗长。
### 问题分析格式
**第一段(500字): 2.1 问题一分析:** 什么什么主要包括几个方面,根据什么什么小类的影响因素决定,建立怎样的模型或体系,提取了什么什么类的指标对数据进行特征训练(如果该问题运用到了学习算法请写出,如果没有使用,请不要写)。
**第二段(500字): 2.2 问题二分析:** 与第一段模板相似。
**第三段(500字): 2.3 问题三分析:** 与第一段模板相似。
请基于已生成的摘要和问题重述，严格按此格式生成问题分析！"""),
    ("human", """请根据以下内容生成问题分析：
摘要内容：{abstract_content}
问题重述内容：{problem_restatement_content}
赛题相关信息：{user_prompt}
知识库参考内容：{context}
要求：严格按指定分段和字数要求生成，术语专业、表述简明！""")
])

# 2.5 模型假设
MODEL_ASSUMPTION_PROMPT = ChatPromptTemplate.from_messages([
    ("system", GLOBAL_AGENT_PROMPT),
    ("system", """数学建模论文模型假设必须严格按照以下要求生成，必须全中文：
1. 共6条假设，必须中文，每条不超过40字；
2. 假设需基于赛题条件和前文（摘要、问题分析）作出，如：假设XX与XX无关系、XX在XX情况下概率相同、XX仅受XX影响等；
3. 假设要贴合实际，符合数学建模逻辑。"""),
    ("human", """请根据以下内容生成6条模型假设：
摘要内容：{abstract_content}
问题分析内容：{problem_analysis_content}
赛题相关信息：{user_prompt}
知识库参考内容：{context}
要求：每条假设≤40字，共6条，必须中文，贴合赛题和前文内容！""")
])

# 2.6 符号说明
SYMBOL_EXPLANATION_PROMPT = ChatPromptTemplate.from_messages([
    ("system", GLOBAL_AGENT_PROMPT),
    ("system", """数学建模论文符号说明必须严格按照以下格式生成，必须全中文：
格式要求："汉字"---"符号"，例如：收益---P；
需包含赛题中的核心词语、建模中使用的矩阵/因素等符号定义；
符号定义要专业、统一，符合数学建模规范。
请基于已生成的摘要、问题分析，严格按此格式生成符号说明！"""),
    ("human", """请根据以下内容生成符号说明：
摘要内容：{abstract_content}
问题分析内容：{problem_analysis_content}
赛题相关信息：{user_prompt}
知识库参考内容：{context}
要求：严格按"汉字---符号"格式生成，覆盖核心概念和建模变量，必须中文！""")
])

# 2.7 模型建立（优化版）
MODEL_BUILDING_PROMPT = ChatPromptTemplate.from_messages([
    ("system", GLOBAL_AGENT_PROMPT),
    ("system", """
### 核心原则
你是数学建模论文写作专家，需严格遵循全国大学生数学建模竞赛（CUMCM）论文规范，生成的内容需满足：学术性（术语准确、逻辑严谨）、关联性（与摘要/问题分析/假设/符号说明强绑定）、准确性（数学公式无错误）、落地性（模型可被复现）。

### 模型建立章节生成规则（总字数2000±10%字，纯中文）
#### 格式要求（强制遵守分段和标题层级）
1. **3.1 问题一模型建立**（600±10%字）：
   - 开篇明确模型类型（如“多元线性回归模型”“灰色预测GM(1,1)模型”“整数规划模型”），并说明选择该模型的理论依据（需结合问题分析中的核心矛盾）；
   - 数学表达式必须使用LaTeX格式排版（如$y = \\beta_0 + \\sum_{{i=1}}^n \\beta_i x_i + \\varepsilon$），所有参数需对应「符号说明内容」中的定义，不得新增未定义符号；
   - 模型建立步骤需分点（1/2/3）说明，包含：问题抽象→变量映射→约束条件确定→目标函数构建→模型验证逻辑；
   - 算法说明需具体（如“采用梯度下降法求解，学习率设置为0.01，迭代次数1000次”），而非泛泛而谈。

2. **3.2 问题二模型建立**（600±10%字）：
   格式与3.1完全一致，需注意：若与问题一模型有承接关系（如“在问题一回归模型基础上引入时间项构建时序模型”），需明确说明；若为独立模型，需解释选择不同模型的原因。

3. **3.3 问题三模型建立**（600±10%字）：
   格式与3.1完全一致，需结合赛题核心需求，优先选择能整合前两个模型结果的综合模型（如“将问题一、二的输出作为输入，构建多目标优化模型”）。

4. **3.4 模型关联性分析**（200±10%字）：
   明确说明三个模型的逻辑关系（递进/互补/嵌套/并行），解释“为何这三个模型组合能完整解决赛题全部问题”，避免空话套话。

#### 禁忌条款
- 禁止使用“大概”“可能”等模糊表述；
- 禁止公式与符号说明冲突；
- 禁止模型类型与问题分析中的核心诉求脱节；
- 禁止抄袭通用模板，所有内容需贴合本次赛题的具体场景。
    """),
    ("human", """
请基于以下上下文生成模型建立章节，严格遵守上述规则：
1. 摘要核心信息：{abstract_content}
2. 问题分析结论：{problem_analysis_content}
3. 模型假设前提：{model_assumption_content}
4. 符号定义清单：{symbol_explanation_content}
5. 赛题完整信息：{user_prompt}
6. 知识库参考：{context}
7. 数据分析结论：{data_analysis_results}

强制要求：
- 所有数学公式使用LaTeX格式，带编号（如公式(3.1)）；
- 模型步骤需具体到可操作层面，而非仅描述概念；
- 字数严格控制在2000±10%字，各分段字数偏差不超过10%；
- 纯中文输出，无英文术语（除非是通用算法名称，如“梯度下降法”可保留英文注释GD）。
    """)
])

# 2.8 模型求解（优化版）
MODEL_SOLVING_PROMPT = ChatPromptTemplate.from_messages([
    ("system", GLOBAL_AGENT_PROMPT),
    ("system", """
### 核心原则
模型求解章节需体现“可重现性”和“专业性”，所有步骤需让读者能通过相同工具/方法得到一致结果，严格遵循CUMCM论文规范，总字数5000±10%字，纯中文。

### 模型求解章节生成规则
#### 格式要求（强制遵守分段和标题层级）
1. **4.1 问题一模型求解**（1500±10%字）：
   - 算法选择：明确求解算法名称（如“牛顿-拉夫逊迭代法”“遗传算法（GA）”“Python scikit-learn的LinearRegression类”），说明选择该算法的原因（如“针对非线性模型收敛速度快”“适合小样本数据”）；
   - 求解步骤：分步骤（1/2/3/4）详细描述，包含：
     ① 数据预处理（如归一化、缺失值填充，需说明具体方法："采用min-max归一化，公式为$x' = (x - x_{{min}})/(x_{{max}} - x_{{min}})$"）；
     ② 算法参数设置（如“遗传算法种群规模50，交叉概率0.8，变异概率0.05，迭代次数200”）；
     ③ 核心计算过程（可给出伪代码或关键公式推导）；
     ④ 求解工具说明（如“使用Python 3.9，核心库：pandas 1.5.3、scipy 1.10.1；或MATLAB R2023a，调用linprog函数”）；
   - 求解结果：给出具体数值（带单位），如“问题一的最优解为：x1=23.5（吨），x2=18.2（万元），目标函数值f(x)=125.8”，必要时列出关键中间结果。

2. **4.2 问题二模型求解**（1500±10%字）：
   格式与4.1完全一致，需注意：若使用与问题一相同的工具/算法，需说明参数调整原因；若使用新工具，需补充环境配置说明（如“MATLAB需安装Optimization Toolbox”）。

3. **4.3 问题三模型求解**（1500±10%字）：
   格式与4.1完全一致，需重点说明“多模型整合求解的逻辑”（如“将问题一、二的求解结果作为约束条件代入问题三的模型，使用Lingo 18.0求解”）。

#### 禁忌条款
- 禁止仅描述“使用Python求解”，需明确到具体库/函数；
- 禁止结果无单位、无具体数值（如仅说“结果符合预期”）；
- 禁止算法步骤跳步（如跳过参数设置直接说“得到结果”）；
- 禁止使用未说明的求解工具。
    """),
    ("human", """
请基于以下上下文生成模型求解章节，严格遵守上述规则：
1. 模型建立内容：{model_building_content}
2. 赛题完整信息：{user_prompt}
3. 知识库参考：{context}
4. 求解结果数据：{solving_results}

强制要求：
- 算法步骤可复现，参数设置具体到数值；
- 求解结果包含具体数值、单位，关键结果可列表展示；
- 字数严格控制在5000±10%字，各分段字数偏差不超过10%；
- 纯中文输出，工具/算法名称可保留英文注释（如“遗传算法（GA）”）。
    """)
])

# 2.9 结果分析（优化版）
RESULTS_ANALYSIS_PROMPT = ChatPromptTemplate.from_messages([
    ("system", GLOBAL_AGENT_PROMPT),
    ("system", """
### 核心原则
结果分析章节需体现“深度”和“实用性”，不仅要解释结果本身，还要结合赛题实际场景解读其现实意义，严格遵循CUMCM论文规范，总字数4500±10%字，纯中文。

### 结果分析章节生成规则
#### 格式要求（强制遵守分段和标题层级）
1. **5.1 问题一结果分析**（1500±10%字）：
   - 可视化说明：明确引用图表（如“见图5-1 问题一目标函数值迭代趋势图”），说明图表类型（折线图/柱状图/热力图）、坐标轴含义（横坐标：迭代次数，纵坐标：目标函数值）、核心特征（如“迭代50次后收敛，收敛值为125.8”）；
   - 合理性分析：结合赛题背景和模型假设，说明结果是否符合现实逻辑（如“结果显示新能源汽车销量年均增长率15%，与国家统计局2024年发布的14.8%接近，验证了结果合理性”）；
   - 关键发现：提炼结果中的核心洞察（如“当补贴政策力度提升10%，销量提升8.5%，说明补贴对销量的弹性系数为0.85”）；
   - 敏感性/误差分析：
     - 敏感性分析：选择1-2个核心参数（如“学习率”“补贴系数”），分析其变化对结果的影响（如“学习率从0.01提升至0.02，收敛速度提升30%，但结果误差增加5%”）；
     - 误差分析：说明误差来源（如“数据采集误差”“模型简化误差”），计算具体误差值（如“均方误差MSE=0.023，相对误差≤5%”）。

2. **5.2 问题二结果分析**（1500±10%字）：
   格式与5.1完全一致，需重点对比问题一、二结果的关联（如“问题二的结果验证了问题一模型的外推性，当时间维度扩展至5年，误差仍控制在8%以内”）。

3. **5.3 问题三结果分析**（1500±10%字）：
   格式与5.1完全一致，需说明综合模型结果的现实应用价值（如“问题三的最优方案可直接为政策制定者提供参考，建议补贴力度控制在10%-15%区间”）。

#### 禁忌条款
- 禁止仅描述图表外观（如“图表呈上升趋势”），需解读图表背后的规律；
- 禁止脱离赛题实际谈结果（如仅分析数学意义，不结合现实场景）；
- 禁止敏感性/误差分析无具体数值；
- 禁止未引用图表却提及“见图X-X”。
    """),
    ("human", """
请基于以下上下文生成结果分析章节，严格遵守上述规则：
1. 模型求解内容：{model_solving_content}
2. 赛题完整信息：{user_prompt}
3. 知识库参考：{context}
4. 图表文件清单：{chart_files}（格式：文件名-图表类型-核心内容，如“fig5-1.png-折线图-问题一迭代趋势”）
5. 统计分析结果：{statistical_results}

强制要求：
- 所有图表引用需与{chart_files}中的清单对应，格式为“见图X-X 图表名称”；
- 敏感性/误差分析需给出具体数值和计算方法；
- 结果解读需结合赛题实际场景，体现现实意义；
- 字数严格控制在4500±10%字，各分段字数偏差不超过10%；
- 纯中文输出，无空洞结论。
    """)
])

__all__ = [
    "GLOBAL_AGENT_PROMPT",
    "ABSTRACT_PROMPT_TEMPLATE",
    "PROBLEM_RESTATEMENT_PROMPT",
    "PROBLEM_ANALYSIS_PROMPT",
    "MODEL_ASSUMPTION_PROMPT",
    "SYMBOL_EXPLANATION_PROMPT",
    "MODEL_BUILDING_PROMPT",
    "MODEL_SOLVING_PROMPT",
    "RESULTS_ANALYSIS_PROMPT",
]

